# Implementation Tasks — Dark Minimal Design System

**Source:** [ImplementationSpec.md](./ImplementationSpec.md) · [DarkMinimalDesign.md](./DarkMinimalDesign.md)
**Status:** In Progress

---

## Pre-Implementation Checklist

Run these before starting Phase 1:

- [x] Grep for all `dark:` classes across `src/` — every match must be addressed
- [x] Grep for all hardcoded hex values in `.astro`, `.css`, `.js` files — all must move to `theme.ts` or be documented as intentionally local
- [x] Grep for `--shiki-light` and `--shiki-dark` references — all must be removed when switching to single Shiki theme

---

## Phase 1 — Centralized Theme + Color Tokens + Remove Light Mode

**Files:** `src/theme.ts` (new), `src/styles/global.css`, `src/config.ts`, `src/layouts/Layout.astro`, `src/scripts/theme.ts`, `src/components/Header.astro`

- [x] **Create `src/theme.ts`** — single source of truth for all colors and typography
  - All background colors: `bgRoot #0E0E0E`, `bgElevated #161616`, `bgSubtle #1A1A1A`, `bgHover #1F1F1F`
  - All border colors: `borderSubtle #2A2A2A`, `borderStrong #3A3A3A`
  - All text colors: `textPrimary #E6E6E6`, `textSecondary #A8A8A8`, `textMuted #7A7A7A`, `textDisabled #5A5A5A`, `headingHero #FFFFFF`, `heading #DADADA`
  - All accent colors: brass (`accentPrimary #D4A259`, `accentPrimaryHover #E6B86A`, `accentPrimaryMuted #7A5A2E`), wine (`accentSecondary #8C5A6A`, `accentSecondaryMuted #5A3A45`), tertiary (`accentTertiary #6F7B4A`)
  - Code block colors: `codeBg #121212`, `codeText #DCDCDC`
  - Typography values: base font size `18px`, line heights, max widths (`blogMaxWidth: 680px`, `libraryMaxWidth: 1100px`)
  - Terminal mode overrides (line-height: `1.7`)
  - Typewriter mode overrides (`textPrimary: #EDE6D6`, line-height: `1.9`)

- [x] **Update `src/config.ts`** — set `lightAndDarkMode: false`

- [x] **Remove/gut `src/scripts/theme.ts`** — no toggle logic needed, reduce to no-op or delete

- [x] **Update `src/layouts/Layout.astro`**
  - Remove inline theme toggle script
  - Hardcode `data-theme="dark"` on `<html>`
  - Import `theme.ts` and generate `<style>:root { ... }</style>` dynamically from theme object
  - Generate `[data-reading-mode="typewriter"] { ... }` overrides from theme override objects
  - Update meta theme-color to static dark value

- [x] **Update `src/styles/global.css`**
  - Remove `:root` color block (hex values now generated by `Layout.astro`)
  - Remove `@custom-variant dark` directive
  - Remove `html[data-theme="light"]` block
  - Remove `html[data-theme="dark"]` block
  - Keep and update `@theme inline` block with new token names (static — maps var names only, never changes when colors change):
    - Add `--font-app` for iA Writer Mono stack
    - Map all `--color-bg-*`, `--color-border-*`, `--color-text-*`, `--color-accent-*` to CSS vars
  - Update `@layer base` selectors to use new tokens
  - Update `max-w-app` to `42.5rem`
  - Add `max-w-library` utility at `68.75rem`
  - Migrate all old Tailwind classes to new semantic tokens (see class migration table)

- [x] **Update `src/components/Header.astro`**
  - Remove theme toggle `<button id="theme-btn">` and its sun/moon icons
  - Update all color classes to semantic tokens

---

## Phase 2 — Typography Rewrite

**Files:** `src/styles/typography.css`, `package.json`

- [x] **Remove `@tailwindcss/typography` plugin** from `package.json` devDependencies

- [x] **Rewrite `src/styles/typography.css`** — hand-roll all prose styles as `.app-prose` class
  - Base: `html { font-size: 18px }`, `body { line-height: 1.8 }`
  - H1: `2.2rem`, weight `600`, line-height `1.2`, color `#FFFFFF` (pure white)
  - H2: `1.6rem`, weight `600`, line-height `1.3`, color `#DADADA`
  - H3: `1.3rem`, weight `500`, line-height `1.4`, color `#DADADA`
  - H4: `1.1rem`, weight `500`, line-height `1.4`, color `#DADADA`
  - Heading rules: no uppercase, no letter-spacing, margin-top `2.5rem+`, margin-bottom `0.75rem`
  - Paragraph bottom margin: `1.6rem`
  - Section spacing: `3rem`
  - Links: color `--accent-primary`, hover → underline + `--accent-primary-hover`
  - Blockquotes: left border `--accent-primary-muted`, text color `--accent-secondary`
  - Inline code: background `#121212`, border `--border-subtle`, padding `2px 6px`, border-radius `4px`
  - Code blocks: background `#121212`, padding `1.4rem`, border `1px solid var(--border-subtle)`, font-size `0.95rem`
  - Lists: marker color `--accent-primary`
  - `<hr>`: color `--border-subtle`
  - Images: border `--border-subtle`
  - Tables: cell border `--border-subtle`, header slightly elevated background
  - Figcaption: `--text-muted`

---

## Phase 3 — Shiki Theme Swap

**Files:** `astro.config.ts`, `src/styles/typography.css`, `src/layouts/PostDetails.astro`, `src/layouts/BookDetails.astro`

- [x] **Update `astro.config.ts`**
  - Change `themes: { light: "min-light", dark: "night-owl" }` → `theme: "vitesse-dark"` (single theme)
  - Remove `light: "min-light"` entirely
  - Set `defaultColor: false`

- [x] **Remove all `--shiki-light` / `--shiki-dark` CSS var references**
  - `typography.css`: Remove `.astro-code` rules referencing `--shiki-light-bg`, `--shiki-dark-bg`, `--shiki-light`, `--shiki-dark`
  - `PostDetails.astro`: Remove `prose-pre:bg-(--shiki-light-bg)` and `dark:prose-pre:bg-(--shiki-dark-bg)` classes (done in Phase 2)
  - `BookDetails.astro`: Same — remove dual-theme Shiki class references (done in Phase 2)

- [x] **Add single `.astro-code` override in CSS**
  ```css
  .astro-code {
    background-color: var(--code-bg) !important;
    border: 1px solid var(--border-subtle);
  }
  ```

---

## Phase 4 — Component Migration

Token class replacements across all components. Reference the migration table in ImplementationSpec §2.

- [x] **`src/components/Card.astro`** — `text-accent` → `text-accent-primary`
- [x] **`src/components/BookCard.astro`** — token updates (layout redesign deferred to Phase 6)
- [x] **`src/components/Tag.astro`** — `border-foreground` → `border-text-primary`, `text-accent` → `text-accent-primary`
- [x] **`src/components/Datetime.astro`** — `opacity-80` → `text-text-secondary`
- [x] **`src/components/Breadcrumb.astro`** — `opacity-80/70/75` → `text-text-secondary`, hover updated to `hover:text-text-primary`
- [x] **`src/components/Pagination.astro`** — `opacity-50` disabled → `text-text-disabled`
- [x] **`src/components/BackToTopButton.astro`** — `bg-background` → `bg-bg-root`, `var(--accent)` → `var(--accent-primary)`
- [x] **`src/components/BackButton.astro`** — `hover:text-foreground/75` → `hover:text-text-secondary`
- [x] **`src/components/Footer.astro`** — `border-border` → `border-border-subtle`
- [x] **`src/components/ShareLinks.astro`** — no old tokens present
- [x] **`src/components/EditPost.astro`** — `opacity-80` → `text-text-secondary`, `hover:text-accent` → `hover:text-accent-primary`
- [x] **`src/components/Socials.astro`** — no old tokens present
- [x] **`src/components/LinkButton.astro`** — `hover:text-accent` → `hover:text-accent-primary`

---

## Phase 5 — Page Migration

- [x] **`src/pages/index.astro`** — `border-border` → `border-border-subtle`, opacity → semantic tokens, `text-accent` → `text-accent-primary`
- [x] **`src/pages/search.astro`** — all Pagefind CSS vars remapped; covers Phase 9
- [x] **`src/pages/404.astro`** — `text-accent` → `text-accent-primary`
- [x] **`src/pages/library/[...page].astro`** — genre filter button tokens updated
- [x] **`src/pages/blog/[...page].astro`** — no old tokens present
- [x] **`src/pages/tags/*`** — no old tokens present
- [x] **`src/layouts/Main.astro`** — no old tokens present
- [x] **`src/layouts/PostDetails.astro`** — H1 → `text-white`, accents updated, inline script class strings updated
- [x] **`src/layouts/BookDetails.astro`** — H1 → `text-white`, all opacity patterns → semantic tokens
- [x] **`src/layouts/AboutLayout.astro`** — `prose-img:border-0` → `[&_img]:border-0`

---

## Phase 6 — Library Card Redesign

**Files:** `src/components/BookCard.astro`, `src/layouts/BookDetails.astro`, `src/pages/library/[...page].astro`

- [x] **Redesign `BookCard.astro`** to vertical layout:
  ```
  ┌─────────────────────┐
  │    [ Cover Image ]  │
  ├─────────────────────┤
  │ Title        (white)│
  │ Author  (secondary) │
  │ Tags        (brass) │
  │ Date        (muted) │
  └─────────────────────┘
  ```
  - Card background: `bg-bg-elevated`
  - Hover: background → `bg-bg-hover`, border → `border-accent-primary-muted`
  - No shadows, no animation beyond subtle opacity/color fade
  - Cover image at top, text below
  - Title: white; Author: `text-text-secondary`; Genre tags: `text-accent-primary`; Notes preview: `text-text-muted`; Favorite quote: `text-accent-secondary`

- [x] **Update library page** — apply `max-w-library` (`68.75rem`) container width via new `wide` prop on `Main.astro`

---

## Phase 7 — OG Image Templates

**Files:** `src/utils/og-templates/post.js`, `src/utils/og-templates/site.js`, `src/utils/loadGoogleFont.ts`

- [x] **Update `src/utils/og-templates/post.js`** — import colors from `src/theme.ts` instead of hardcoded hex values
- [x] **Update `src/utils/og-templates/site.js`** — import colors from `src/theme.ts` instead of hardcoded hex values
- [x] **Handle font for OG images in `loadGoogleFont.ts`**
  - iA Writer Mono is not a Google Font (loaded via `@fontsource`)
  - Option A chosen: Load `.woff` font buffer from `@fontsource/ia-writer-mono` package and pass to Satori
  - Note: Satori does not support WOFF2 — `.woff` files used instead
  - Decision documented in code comments

---

## Phase 8 — Terminal / Typewriter Mode Toggle

**Files:** New toggle component, `src/layouts/Layout.astro`, reading-mode CSS

- [x] **Create reading mode toggle component**
  - Placement: subtle icon in header nav (where theme toggle was)
  - Two states: `"terminal"` (default) | `"typewriter"`
  - Store preference in `localStorage` as `"reading-mode"`
  - Apply via `data-reading-mode` attribute on `<html>`

- [x] **Generate reading mode CSS from `theme.ts`** in `Layout.astro`
  - Terminal (default): `--body-line-height: 1.7` in cssVars
  - Typewriter: `--text-primary: #EDE6D6`, `--body-line-height: 1.9` in readingModes
  - Structural: `[data-reading-mode="typewriter"] #top-nav-wrap { border-bottom-color: transparent }`

- [x] **Handle Astro view transitions** — `is:inline` script in `<head>` prevents flash on initial load; `astro:after-swap` listener in component re-applies `data-reading-mode` after navigation

---

## Phase 9 — Pagefind Search Theming

**Files:** `src/pages/search.astro`

- [x] **Update Pagefind CSS vars** in `search.astro`:
  ```css
  #pagefind-search {
    --pagefind-ui-font: var(--font-app);
    --pagefind-ui-text: var(--text-primary);
    --pagefind-ui-background: var(--bg-root);
    --pagefind-ui-border: var(--border-subtle);
    --pagefind-ui-primary: var(--accent-primary);
    --pagefind-ui-tag: var(--bg-elevated);
  }
  ```
- [x] Remove any remaining `dark:` references in `search.astro`

---

## Phase 10 — Visual Audit & Accessibility Check

- [x] Full site walkthrough in browser — check all pages and components
- [x] Verify contrast ratios:
  - `--text-primary #E6E6E6` → 16.5:1 ✅
  - `--text-secondary #A8A8A8` → 9.2:1 ✅
  - `--text-muted #7A7A7A` → 5.5:1 ✅
  - `--text-disabled #5A5A5A` → 3.7:1 ⚠️ (disabled elements only — WCAG acceptable)
  - `--accent-primary #D4A259` → 8.5:1 ✅
  - `--accent-secondary #8C5A6A` → 4.1:1 ⚠️ (blockquotes / large text / decorative only)
- [x] Confirm `--accent-secondary` (wine) is only used in `typography.css` blockquotes (large text — WCAG acceptable)
- [x] Confirm `--text-disabled` is only applied to disabled/non-interactive Pagination buttons
- [x] Check all hardcoded hex values are gone from `.astro`, `.css`, `.js` files — only `#0E0E0E` in `<meta name="theme-color">` (intentionally local, not a CSS property)
- [x] Check no `dark:` classes remain in the codebase — none found
- [x] Check no `--shiki-light` / `--shiki-dark` references remain — none found
- [x] Run `pnpm run build` — 0 errors, 0 warnings, 62 pages built
- [x] Run `pnpm run lint` and `pnpm run format:check` — both pass; added `public/pagefind` to `.prettierignore`
- [ ] Test reading mode toggle (terminal ↔ typewriter) in browser — verify localStorage persistence and view transition re-application

---

## Tailwind Class Migration Reference

| Old | New |
|---|---|
| `bg-background` | `bg-bg-root` |
| `bg-muted` | `bg-bg-subtle` |
| `text-foreground` | `text-text-primary` |
| `text-accent` | `text-accent-primary` |
| `border-border` | `border-border-subtle` |
| `outline-accent` | `outline-accent-primary` |
| `selection:bg-accent` | `selection:bg-accent-primary` |
| `selection:text-background` | `selection:text-bg-root` |
| `hover:text-accent` | `hover:text-accent-primary-hover` |
| `opacity-80` (on text) | `text-text-secondary` |
| `opacity-70` (on text) | `text-text-secondary` |
| `opacity-60` (on text) | `text-text-muted` |
| `opacity-50` (disabled) | `text-text-disabled` |
