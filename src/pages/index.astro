---
import { getCollection } from "astro:content";
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import timezone from "dayjs/plugin/timezone";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import getPostsByGroupCondition from "@/utils/getPostsByGroupCondition";
import { getPath } from "@/utils/getPath";
import { SITE } from "@/config";

dayjs.extend(utc);
dayjs.extend(timezone);

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const groupedPosts = getPostsByGroupCondition(sortedPosts, post =>
  dayjs(post.data.pubDatetime).tz(SITE.timezone).format("YYYY MMMM")
);
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index" class="app-layout">
    <section
      id="hero"
      class:list={["pt-8 pb-6", "border-b border-border-subtle"]}
    >
      <h1 class="my-4 inline-block text-3xl font-bold sm:my-8 sm:text-4xl">
        The Inner Dialogue
      </h1>
      <p>
        A space for thinking out loud â€” notes on software, design, books and the
        things in between.
      </p>
    </section>

    <section id="all-posts" class="pt-8 pb-6">
      {
        Object.entries(groupedPosts).map(([group, groupPosts]) => (
          <div class="mb-10">
            <h2 class="mb-3 text-lg font-medium text-text-secondary">
              {group}
            </h2>
            <ul>
              {groupPosts.map(post => {
                const date = dayjs(post.data.pubDatetime).tz(SITE.timezone);
                return (
                  <li class="flex items-center justify-between py-2.5">
                    <a
                      href={getPath(post.id, post.filePath)}
                      class="text-accent-primary decoration-dashed underline-offset-4 hover:underline"
                    >
                      {post.data.title}
                    </a>
                    <time
                      datetime={date.toISOString()}
                      class="ml-6 shrink-0 text-sm text-text-muted"
                    >
                      {date.format("D MMM, YYYY")}
                    </time>
                  </li>
                );
              })}
            </ul>
          </div>
        ))
      }
    </section>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
